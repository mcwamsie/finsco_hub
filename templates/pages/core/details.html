{% extends "layouts/layout_base.html" %}
{% load static %}

{% block page_title %}{{ object.name|default:"Item Details" }}{% endblock %}

{% block breadcrumb_items %}
<li class="flex items-center">
    <i class="bi bi-chevron-right text-xs mx-2"></i>
    <a href="{% url 'list_view' %}" class="text-gray-600 hover:text-gray-800">List</a>
</li>
<li class="flex items-center">
    <i class="bi bi-chevron-right text-xs mx-2"></i>
    <span class="text-gray-900">{{ object.name|default:"Details" }}</span>
</li>
{% endblock %}

{% block page_actions %}
<div class="flex items-center gap-2">
    <button class="text-sm text-gray-600 hover:text-gray-800 flex items-center gap-1" onclick="toggleHistory()">
        <i class="bi bi-clock-history"></i>
        History
    </button>
    <button class="text-sm text-gray-600 hover:text-gray-800 flex items-center gap-1" onclick="shareItem()">
        <i class="bi bi-share"></i>
        Share
    </button>
    <button class="text-sm text-gray-600 hover:text-gray-800 flex items-center gap-1" onclick="printDetails()">
        <i class="bi bi-printer"></i>
        Print
    </button>
</div>
{% endblock %}

{% block header_actions %}
<div class="flex items-center gap-2">
    <button class="btn-secondary px-3 py-2 text-sm" onclick="goBack()" data-loading data-loading-text="Loading...">
        <i class="bi bi-arrow-left mr-1"></i>
        Back to List
    </button>
    <button class="btn-secondary px-3 py-2 text-sm" onclick="duplicateItem()" data-loading data-loading-text="Duplicating...">
        <i class="bi bi-files mr-1"></i>
        Duplicate
    </button>
    <button class="btn-primary px-4 py-2 text-sm" onclick="editItem()" data-action="edit-item">
        <i class="bi bi-pencil mr-1"></i>
        Edit
    </button>
</div>
{% endblock %}

{% block main_content %}
<div class="flex h-full">
    <!-- Main Content -->
    <div class="flex-1 overflow-auto">
        <div class="max-w-4xl mx-auto p-6">
            <!-- Item Header -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                <div class="p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center text-white text-xl font-bold">
                                {{ object.name.0|upper }}{{ object.name.1|upper|default:"" }}
                            </div>
                            <div>
                                <h1 class="text-2xl font-bold text-gray-900 mb-1">{{ object.name }}</h1>
                                <p class="text-gray-600">{{ object.description|default:"No description available" }}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                                {% if object.status == 'active' %}bg-green-100 text-green-800
                                {% elif object.status == 'inactive' %}bg-red-100 text-red-800
                                {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                <span class="w-2 h-2 rounded-full mr-2
                                    {% if object.status == 'active' %}bg-green-400
                                    {% elif object.status == 'inactive' %}bg-red-400
                                    {% else %}bg-yellow-400{% endif %}"></span>
                                {{ object.status|title }}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 pt-4 border-t border-gray-200">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-900">{{ object.created_at|date:"M d" }}</div>
                            <div class="text-sm text-gray-500">Created</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-900">{{ object.updated_at|date:"M d" }}</div>
                            <div class="text-sm text-gray-500">Last Updated</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-900">{{ object.category|default:"-" }}</div>
                            <div class="text-sm text-gray-500">Category</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-900">{{ object.priority|default:"-" }}</div>
                            <div class="text-sm text-gray-500">Priority</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Details Tabs -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <!-- Tab Navigation -->
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-6" aria-label="Tabs">
                        <button class="tab-button active py-4 px-1 border-b-2 font-medium text-sm" 
                                data-tab="overview" 
                                onclick="switchTab('overview')">
                            <i class="bi bi-info-circle mr-2"></i>
                            Overview
                        </button>
                        <button class="tab-button py-4 px-1 border-b-2 font-medium text-sm" 
                                data-tab="details" 
                                onclick="switchTab('details')">
                            <i class="bi bi-list-ul mr-2"></i>
                            Details
                        </button>
                        <button class="tab-button py-4 px-1 border-b-2 font-medium text-sm" 
                                data-tab="activity" 
                                onclick="switchTab('activity')">
                            <i class="bi bi-clock-history mr-2"></i>
                            Activity
                        </button>
                        <button class="tab-button py-4 px-1 border-b-2 font-medium text-sm" 
                                data-tab="attachments" 
                                onclick="switchTab('attachments')">
                            <i class="bi bi-paperclip mr-2"></i>
                            Attachments
                        </button>
                    </nav>
                </div>
                
                <!-- Tab Content -->
                <div class="p-6">
                    <!-- Overview Tab -->
                    <div id="overview-tab" class="tab-content">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Basic Information</h3>
                                <dl class="space-y-3">
                                    <div class="flex justify-between">
                                        <dt class="text-sm font-medium text-gray-500">Name</dt>
                                        <dd class="text-sm text-gray-900">{{ object.name }}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-sm font-medium text-gray-500">Status</dt>
                                        <dd class="text-sm text-gray-900">{{ object.status|title }}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-sm font-medium text-gray-500">Category</dt>
                                        <dd class="text-sm text-gray-900">{{ object.category|default:"-" }}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-sm font-medium text-gray-500">Priority</dt>
                                        <dd class="text-sm text-gray-900">{{ object.priority|default:"-" }}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-sm font-medium text-gray-500">Created By</dt>
                                        <dd class="text-sm text-gray-900">{{ object.created_by|default:"-" }}</dd>
                                    </div>
                                </dl>
                            </div>
                            
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Timestamps</h3>
                                <dl class="space-y-3">
                                    <div class="flex justify-between">
                                        <dt class="text-sm font-medium text-gray-500">Created</dt>
                                        <dd class="text-sm text-gray-900">{{ object.created_at|date:"F d, Y g:i A" }}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-sm font-medium text-gray-500">Last Updated</dt>
                                        <dd class="text-sm text-gray-900">{{ object.updated_at|date:"F d, Y g:i A" }}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-sm font-medium text-gray-500">Last Modified By</dt>
                                        <dd class="text-sm text-gray-900">{{ object.updated_by|default:"-" }}</dd>
                                    </div>
                                </dl>
                            </div>
                        </div>
                        
                        {% if object.description %}
                        <div class="mt-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Description</h3>
                            <div class="prose max-w-none">
                                <p class="text-gray-700">{{ object.description|linebreaks }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Details Tab -->
                    <div id="details-tab" class="tab-content hidden">
                        <div class="space-y-6">
                            {% for field_group in field_groups %}
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">{{ field_group.name }}</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {% for field in field_group.fields %}
                                    <div class="bg-gray-50 rounded-lg p-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">{{ field.label }}</label>
                                        <div class="text-sm text-gray-900">
                                            {% if field.type == 'boolean' %}
                                                <span class="inline-flex items-center">
                                                    <i class="bi bi-{% if field.value %}check-circle text-green-500{% else %}x-circle text-red-500{% endif %} mr-1"></i>
                                                    {{ field.value|yesno:"Yes,No" }}
                                                </span>
                                            {% elif field.type == 'url' %}
                                                <a href="{{ field.value }}" target="_blank" class="text-blue-600 hover:text-blue-800">{{ field.value }}</a>
                                            {% elif field.type == 'email' %}
                                                <a href="mailto:{{ field.value }}" class="text-blue-600 hover:text-blue-800">{{ field.value }}</a>
                                            {% else %}
                                                {{ field.value|default:"-" }}
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% empty %}
                            <div class="text-center py-8">
                                <i class="bi bi-info-circle text-4xl text-gray-300 mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">No additional details</h3>
                                <p class="text-gray-500">Additional field information will appear here when available.</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Activity Tab -->
                    <div id="activity-tab" class="tab-content hidden">
                        <div class="space-y-4">
                            {% for activity in activities %}
                            <div class="flex items-start gap-3 p-4 bg-gray-50 rounded-lg">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm">
                                    <i class="bi bi-{{ activity.icon|default:'clock' }}"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center justify-between mb-1">
                                        <h4 class="text-sm font-medium text-gray-900">{{ activity.title }}</h4>
                                        <span class="text-xs text-gray-500">{{ activity.timestamp|timesince }} ago</span>
                                    </div>
                                    <p class="text-sm text-gray-600">{{ activity.description }}</p>
                                    {% if activity.user %}
                                    <p class="text-xs text-gray-500 mt-1">by {{ activity.user }}</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% empty %}
                            <div class="text-center py-8">
                                <i class="bi bi-clock-history text-4xl text-gray-300 mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">No activity yet</h3>
                                <p class="text-gray-500">Activity history will appear here as changes are made.</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Attachments Tab -->
                    <div id="attachments-tab" class="tab-content hidden">
                        <div class="space-y-4">
                            {% for attachment in attachments %}
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <i class="bi bi-file-earmark text-blue-600"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-sm font-medium text-gray-900">{{ attachment.name }}</h4>
                                        <p class="text-xs text-gray-500">{{ attachment.size|filesizeformat }} • {{ attachment.uploaded_at|date:"M d, Y" }}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button class="p-2 text-gray-400 hover:text-blue-600" onclick="downloadAttachment('{{ attachment.id }}')" title="Download">
                                        <i class="bi bi-download"></i>
                                    </button>
                                    <button class="p-2 text-gray-400 hover:text-red-600" onclick="deleteAttachment('{{ attachment.id }}')" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            {% empty %}
                            <div class="text-center py-8">
                                <i class="bi bi-paperclip text-4xl text-gray-300 mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">No attachments</h3>
                                <p class="text-gray-500 mb-4">Upload files to attach them to this item.</p>
                                <button class="btn-primary px-4 py-2" onclick="uploadAttachment()">
                                    <i class="bi bi-plus mr-1"></i>
                                    Add Attachment
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="w-80 bg-gray-50 border-l border-gray-200 overflow-auto">
        <div class="p-6">
            <!-- Quick Actions -->
            <div class="mb-6">
                <h3 class="text-sm font-semibold text-gray-900 mb-3">Quick Actions</h3>
                <div class="space-y-2">
                    <button class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg flex items-center gap-2" 
                            onclick="editItem()" 
                            data-loading data-loading-text="Loading...">
                        <i class="bi bi-pencil"></i>
                        Edit Item
                    </button>
                    <button class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg flex items-center gap-2" 
                            onclick="duplicateItem()" 
                            data-loading data-loading-text="Duplicating...">
                        <i class="bi bi-files"></i>
                        Duplicate
                    </button>
                    <button class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg flex items-center gap-2" 
                            onclick="archiveItem()" 
                            data-loading data-loading-text="Archiving...">
                        <i class="bi bi-archive"></i>
                        Archive
                    </button>
                    <button class="w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg flex items-center gap-2" 
                            onclick="deleteItem()" 
                            data-loading data-loading-text="Deleting...">
                        <i class="bi bi-trash"></i>
                        Delete
                    </button>
                </div>
            </div>
            
            <!-- Related Items -->
            <div class="mb-6">
                <h3 class="text-sm font-semibold text-gray-900 mb-3">Related Items</h3>
                <div class="space-y-2">
                    {% for related in related_items %}
                    <a href="{% url 'detail_view' related.id %}" 
                       class="block p-3 bg-white rounded-lg border border-gray-200 hover:border-gray-300 transition-colors">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center text-xs">
                                {{ related.name.0|upper }}
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 truncate">{{ related.name }}</p>
                                <p class="text-xs text-gray-500">{{ related.type }}</p>
                            </div>
                        </div>
                    </a>
                    {% empty %}
                    <p class="text-sm text-gray-500">No related items found.</p>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div>
                <h3 class="text-sm font-semibold text-gray-900 mb-3">Recent Activity</h3>
                <div class="space-y-3">
                    {% for activity in recent_activities|slice:":5" %}
                    <div class="flex items-start gap-2">
                        <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center mt-0.5">
                            <i class="bi bi-{{ activity.icon|default:'clock' }} text-xs text-blue-600"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs text-gray-900">{{ activity.title }}</p>
                            <p class="text-xs text-gray-500">{{ activity.timestamp|timesince }} ago</p>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-sm text-gray-500">No recent activity.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Modals will be included here -->
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
let currentTab = 'overview';

document.addEventListener('DOMContentLoaded', function() {
    initializeDetailsView();
    setupKeyboardShortcuts();
});

function initializeDetailsView() {
    // Initialize tab functionality
    switchTab('overview');
    
    // Setup auto-save for any editable fields
    setupAutoSave();
}

function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'e':
                    e.preventDefault();
                    editItem();
                    break;
                case 'b':
                    e.preventDefault();
                    goBack();
                    break;
                case 'd':
                    e.preventDefault();
                    duplicateItem();
                    break;
            }
        }
        
        // Tab navigation with arrow keys
        if (e.altKey) {
            const tabs = ['overview', 'details', 'activity', 'attachments'];
            const currentIndex = tabs.indexOf(currentTab);
            
            if (e.key === 'ArrowLeft' && currentIndex > 0) {
                e.preventDefault();
                switchTab(tabs[currentIndex - 1]);
            } else if (e.key === 'ArrowRight' && currentIndex < tabs.length - 1) {
                e.preventDefault();
                switchTab(tabs[currentIndex + 1]);
            }
        }
    });
}

function switchTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active', 'border-airtable-blue', 'text-airtable-blue');
        button.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
    });
    
    // Show selected tab content
    const selectedContent = document.getElementById(`${tabName}-tab`);
    if (selectedContent) {
        selectedContent.classList.remove('hidden');
    }
    
    // Add active class to selected tab button
    const selectedButton = document.querySelector(`[data-tab="${tabName}"]`);
    if (selectedButton) {
        selectedButton.classList.add('active', 'border-airtable-blue', 'text-airtable-blue');
        selectedButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
    }
    
    currentTab = tabName;
    
    // Load tab-specific data if needed
    loadTabData(tabName);
}

function loadTabData(tabName) {
    switch(tabName) {
        case 'activity':
            loadActivityData();
            break;
        case 'attachments':
            loadAttachments();
            break;
    }
}

function loadActivityData() {
    // Simulate loading activity data
    showToast('Loading activity...', 'info');
}

function loadAttachments() {
    // Simulate loading attachments
    showToast('Loading attachments...', 'info');
}

function goBack() {
    window.history.back();
}

function editItem() {
    const itemId = '{{ object.id }}';
    window.location.href = `/edit/${itemId}/`;
}

function duplicateItem() {
    if (confirm('Are you sure you want to duplicate this item?')) {
        showPageLoading();
        
        // Simulate API call
        setTimeout(() => {
            hidePageLoading();
            showToast('Item duplicated successfully', 'success');
        }, 1000);
    }
}

function archiveItem() {
    if (confirm('Are you sure you want to archive this item?')) {
        showPageLoading();
        
        // Simulate API call
        setTimeout(() => {
            hidePageLoading();
            showToast('Item archived successfully', 'success');
            window.location.href = '/list/';
        }, 1000);
    }
}

function deleteItem() {
    if (confirm('Are you sure you want to delete this item? This action cannot be undone.')) {
        showPageLoading();
        
        // Simulate API call
        setTimeout(() => {
            hidePageLoading();
            showToast('Item deleted successfully', 'success');
            window.location.href = '/list/';
        }, 1000);
    }
}

function shareItem() {
    // Implementation for sharing functionality
    showToast('Share functionality coming soon', 'info');
}

function printDetails() {
    window.print();
}

function toggleHistory() {
    switchTab('activity');
}

function uploadAttachment() {
    // Implementation for file upload
    showToast('Upload functionality coming soon', 'info');
}

function downloadAttachment(attachmentId) {
    showToast('Downloading attachment...', 'info');
    // Implementation for download
}

function deleteAttachment(attachmentId) {
    if (confirm('Are you sure you want to delete this attachment?')) {
        showToast('Attachment deleted', 'success');
        // Remove attachment from DOM
        const attachmentElement = document.querySelector(`[data-attachment-id="${attachmentId}"]`);
        if (attachmentElement) {
            attachmentElement.remove();
        }
    }
}

function setupAutoSave() {
    // Setup auto-save for any editable fields
    const editableFields = document.querySelectorAll('[data-autosave]');
    
    editableFields.forEach(field => {
        let saveTimeout;
        
        field.addEventListener('input', function() {
            clearTimeout(saveTimeout);
            updateSaveStatus('saving');
            
            saveTimeout = setTimeout(() => {
                // Simulate auto-save
                updateSaveStatus('saved');
            }, 1000);
        });
    });
}
</script>
{% endblock %}